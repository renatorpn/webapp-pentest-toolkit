#!/bin/bash

packages=(
    "ca-certificates"
    "curl"
    "gnupg"
    "python3"
    "golang"
    "git"
)

function update_upgrade() {
    sudo apt-get update
    sudo apt-get full-upgrade -y
}
function core_packages_install(){
    echo "++++ PACKAGE INSTALLATION ++++"
    for package_name in "${packages[@]}"; do
        echo "Installing package: $package_name"
        sudo apt-get -qq install -y "package_name"
        
        check_package_install "$package_name"
    done
}
function docker_install(){
    echo "++++ INSTALLING DOCKER ++++"
    
    echo "Removing older docker installations..."
    sudo apt-get --q remove -y docker docker-engine docker.io containerd runc

    echo "Adding Docker GPG..."
    sudo install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    sudo chmod a+r /etc/apt/keyrings/docker.gpg

    echo "Setting up repo..."
    echo \
    "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
    "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
    sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

    echo "Installing Docker..."
    sudo apt-get -qq update
    sudo apt-get -qq install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

    echo "Verifying docker installation..."
    bash -n -c "docker run hello-world"

    check_package_install "docker"
}
function crapi_setup(){
    echo "Setting up OWASP crAPI..."
    curl -o docker-compose.yml https://raw.githubusercontent.com/OWASP/crAPI/main/deploy/docker/docker-compose.yml
    echo "Spinning app container..."
    sudo docker-compose pull
    sudo docker-compose -f docker-compose.yml --compatibility up -d
}

function devslop_pixi_setup(){
    echo "Setting up DevSlop's Pixi..."
    git clone https://github.com/DevSlop/Pixi.git
    echo "Spinning app container..."
    sudo docker-compose -f Pixi/docker-compose.yaml up
}

function juiceshop_setup(){
    echo "Setting up OWASP's Juiceshop..."
    echo "Pulling OWASP Juiceshop docker image..."
    sudo docker pull bkimminich/juice-shop
    echo "Setting up Juiceshop docker image at port 3000..."
    sudo docker run --rm -p 80:3000 bkimminich/juice-shop

}

function dvga_setup(){
    echo "Setting up Damn Vulnerable GraphQL Application..."
    echo "Pulling DVGA docker image..."
    sudo docker pull dolevf/dvga
    echo "Setting up DVGA docker image at port 5000..."
    sudo docker run -t -p 5000:5000 -e WEB_HOST=0.0.0.0 dolevf/dvga
    
}

function app_setup(){
    echo "++++ SETTING UP APPLICATIONS ++++"
    crapi_setup
    devslop_pixi_setup
    juiceshop_setup
}

function check_package_install(){
    if [ $? -eq 0 ]; then
        echo "Package $1 installed successfully!"
    else
        echo "Package $1 installation failed!"
    fi
}

function install_tools(){
    core_packages_install
    docker_install
}

update_upgrade
install_tools
app_setup